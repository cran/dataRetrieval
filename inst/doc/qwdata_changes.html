<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />

<meta name="viewport" content="width=device-width, initial-scale=1" />

<meta name="author" content="Laura A. DeCicco" />


<title>Changes to NWIS QW services</title>

<script>// Pandoc 2.9 adds attributes on both header and div. We remove the former (to
// be compatible with the behavior of Pandoc < 2.8).
document.addEventListener('DOMContentLoaded', function(e) {
  var hs = document.querySelectorAll("div.section[class*='level'] > :first-child");
  var i, h, a;
  for (i = 0; i < hs.length; i++) {
    h = hs[i];
    if (!/^h[1-6]$/i.test(h.tagName)) continue;  // it should be a header h1-h6
    a = h.attributes;
    while (a.length > 0) h.removeAttribute(a[0].name);
  }
});
</script>

<style type="text/css">
code{white-space: pre-wrap;}
span.smallcaps{font-variant: small-caps;}
span.underline{text-decoration: underline;}
div.column{display: inline-block; vertical-align: top; width: 50%;}
div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
ul.task-list{list-style: none;}
</style>



<style type="text/css">
code {
white-space: pre;
}
.sourceCode {
overflow: visible;
}
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { display: inline-block; text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
{ counter-reset: source-line 0; }
pre.numberSource code > span
{ position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
{ content: counter(source-line);
position: relative; left: -1em; text-align: right; vertical-align: baseline;
border: none; display: inline-block;
-webkit-touch-callout: none; -webkit-user-select: none;
-khtml-user-select: none; -moz-user-select: none;
-ms-user-select: none; user-select: none;
padding: 0 4px; width: 4em;
color: #aaaaaa;
}
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa; padding-left: 4px; }
div.sourceCode
{ }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } 
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.at { color: #7d9029; } 
code span.bn { color: #40a070; } 
code span.bu { color: #008000; } 
code span.cf { color: #007020; font-weight: bold; } 
code span.ch { color: #4070a0; } 
code span.cn { color: #880000; } 
code span.co { color: #60a0b0; font-style: italic; } 
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.do { color: #ba2121; font-style: italic; } 
code span.dt { color: #902000; } 
code span.dv { color: #40a070; } 
code span.er { color: #ff0000; font-weight: bold; } 
code span.ex { } 
code span.fl { color: #40a070; } 
code span.fu { color: #06287e; } 
code span.im { color: #008000; font-weight: bold; } 
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } 
code span.kw { color: #007020; font-weight: bold; } 
code span.op { color: #666666; } 
code span.ot { color: #007020; } 
code span.pp { color: #bc7a00; } 
code span.sc { color: #4070a0; } 
code span.ss { color: #bb6688; } 
code span.st { color: #4070a0; } 
code span.va { color: #19177c; } 
code span.vs { color: #4070a0; } 
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } 
</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<style type="text/css">body {
background-color: #fff;
margin: 1em auto;
max-width: 700px;
overflow: visible;
padding-left: 2em;
padding-right: 2em;
font-family: "Open Sans", "Helvetica Neue", Helvetica, Arial, sans-serif;
font-size: 14px;
line-height: 1.35;
}
#TOC {
clear: both;
margin: 0 0 10px 10px;
padding: 4px;
width: 400px;
border: 1px solid #CCCCCC;
border-radius: 5px;
background-color: #f6f6f6;
font-size: 13px;
line-height: 1.3;
}
#TOC .toctitle {
font-weight: bold;
font-size: 15px;
margin-left: 5px;
}
#TOC ul {
padding-left: 40px;
margin-left: -1.5em;
margin-top: 5px;
margin-bottom: 5px;
}
#TOC ul ul {
margin-left: -2em;
}
#TOC li {
line-height: 16px;
}
table {
margin: 1em auto;
border-width: 1px;
border-color: #DDDDDD;
border-style: outset;
border-collapse: collapse;
}
table th {
border-width: 2px;
padding: 5px;
border-style: inset;
}
table td {
border-width: 1px;
border-style: inset;
line-height: 18px;
padding: 5px 5px;
}
table, table th, table td {
border-left-style: none;
border-right-style: none;
}
table thead, table tr.even {
background-color: #f7f7f7;
}
p {
margin: 0.5em 0;
}
blockquote {
background-color: #f6f6f6;
padding: 0.25em 0.75em;
}
hr {
border-style: solid;
border: none;
border-top: 1px solid #777;
margin: 28px 0;
}
dl {
margin-left: 0;
}
dl dd {
margin-bottom: 13px;
margin-left: 13px;
}
dl dt {
font-weight: bold;
}
ul {
margin-top: 0;
}
ul li {
list-style: circle outside;
}
ul ul {
margin-bottom: 0;
}
pre, code {
background-color: #f7f7f7;
border-radius: 3px;
color: #333;
white-space: pre-wrap; 
}
pre {
border-radius: 3px;
margin: 5px 0px 10px 0px;
padding: 10px;
}
pre:not([class]) {
background-color: #f7f7f7;
}
code {
font-family: Consolas, Monaco, 'Courier New', monospace;
font-size: 85%;
}
p > code, li > code {
padding: 2px 0px;
}
div.figure {
text-align: center;
}
img {
background-color: #FFFFFF;
padding: 2px;
border: 1px solid #DDDDDD;
border-radius: 3px;
border: 1px solid #CCCCCC;
margin: 0 5px;
}
h1 {
margin-top: 0;
font-size: 35px;
line-height: 40px;
}
h2 {
border-bottom: 4px solid #f7f7f7;
padding-top: 10px;
padding-bottom: 2px;
font-size: 145%;
}
h3 {
border-bottom: 2px solid #f7f7f7;
padding-top: 10px;
font-size: 120%;
}
h4 {
border-bottom: 1px solid #f7f7f7;
margin-left: 8px;
font-size: 105%;
}
h5, h6 {
border-bottom: 1px solid #ccc;
font-size: 105%;
}
a {
color: #0033dd;
text-decoration: none;
}
a:hover {
color: #6666ff; }
a:visited {
color: #800080; }
a:visited:hover {
color: #BB00BB; }
a[href^="http:"] {
text-decoration: underline; }
a[href^="https:"] {
text-decoration: underline; }

code > span.kw { color: #555; font-weight: bold; } 
code > span.dt { color: #902000; } 
code > span.dv { color: #40a070; } 
code > span.bn { color: #d14; } 
code > span.fl { color: #d14; } 
code > span.ch { color: #d14; } 
code > span.st { color: #d14; } 
code > span.co { color: #888888; font-style: italic; } 
code > span.ot { color: #007020; } 
code > span.al { color: #ff0000; font-weight: bold; } 
code > span.fu { color: #900; font-weight: bold; } 
code > span.er { color: #a61717; background-color: #e3d2d2; } 
</style>




</head>

<body>




<h1 class="title toc-ignore">Changes to NWIS QW services</h1>
<h4 class="author">Laura A. DeCicco</h4>


<div id="TOC">
<ul>
<li><a href="#changes-to-nwis-water-quality-services" id="toc-changes-to-nwis-water-quality-services"><span class="toc-section-number">1</span> Changes to NWIS water quality
services</a></li>
<li><a href="#how-to-find-more-help" id="toc-how-to-find-more-help"><span class="toc-section-number">2</span>
How to find more help</a></li>
<li><a href="#wqx2---wqx3" id="toc-wqx2---wqx3"><span class="toc-section-number">3</span> WQX2 -&gt; WQX3</a></li>
<li><a href="#nwis---wqx3" id="toc-nwis---wqx3"><span class="toc-section-number">4</span> NWIS -&gt; WQX3</a>
<ul>
<li><a href="#readnwisqw" id="toc-readnwisqw"><span class="toc-section-number">4.1</span> <code>readNWISqw</code></a>
<ul>
<li><a href="#censored-values" id="toc-censored-values"><span class="toc-section-number">4.1.1</span> Censored values</a></li>
<li><a href="#nwis-codes" id="toc-nwis-codes"><span class="toc-section-number">4.1.2</span> NWIS codes</a></li>
</ul></li>
</ul></li>
<li><a href="#whatnwisdata" id="toc-whatnwisdata"><span class="toc-section-number">5</span> whatNWISdata</a></li>
<li><a href="#readnwisdata" id="toc-readnwisdata"><span class="toc-section-number">6</span> readNWISdata</a></li>
<li><a href="#conversion" id="toc-conversion"><span class="toc-section-number">7</span> WQX Conversion</a></li>
<li><a href="#disclaimer" id="toc-disclaimer"><span class="toc-section-number">8</span> Disclaimer</a></li>
</ul>
</div>

<p><strong>IMPORTANT</strong> These recommendations have been updated
using WQX3.0 profiles.</p>
<div id="changes-to-nwis-water-quality-services" class="section level1" number="1">
<h1><span class="header-section-number">1</span> Changes to NWIS water
quality services</h1>
<p>USGS discrete water samples data are undergoing modernization, and
NWIS services will no longer be updated with the latest data starting
mid-March 2024, with a full decommission expected 6 months later.</p>
<p>For the latest news on USGS water quality data, see: <a href="https://doi-usgs.github.io/dataRetrieval/articles/Status.html">https://doi-usgs.github.io/dataRetrieval/articles/Status.html</a>.
Learn more about the changes and where to find the new samples data in
the <a href="https://waterdata.usgs.gov/blog/changes-to-sample-data/">WDFN
blog</a>.</p>
<p>What does this mean for <code>dataRetrieval</code> users? Eventually
water quality data will ONLY be available from the <a href="https://www.waterqualitydata.us/">Water Quality Portal</a> rather
than the NWIS services. There are 3 major <code>dataRetrieval</code>
functions that will be affected: <code>readNWISqw</code>,
<code>whatNWISdata</code>, and <code>readNWISdata</code>. This vignette
will describe the most common workflows conversions needed to update
existing scripts.</p>
</div>
<div id="how-to-find-more-help" class="section level1" number="2">
<h1><span class="header-section-number">2</span> How to find more
help</h1>
<p>This vignette is being provided in advance of any breaking changes,
and more information and guidance will be provided. These changes are
big, and initially sound overwhelming. But in the end, they are
thoughtful changes that will make understanding USGS water data more
intuitive. Please reach out for questions and comments to: <a href="mailto:gs-w-IOW_PO_team@usgs.gov" class="email">gs-w-IOW_PO_team@usgs.gov</a></p>
</div>
<div id="wqx2---wqx3" class="section level1" number="3">
<h1><span class="header-section-number">3</span> WQX2 -&gt; WQX3</h1>
<p>If you have already converted your workflow from NWIS to WQP, much of
the hard work has been done! The final step of the process is to make
sure workflows are using the most modern WQX3 formats. WQX stands for
Water Quality Exchange. WQX2 is the format that has been historically
available on the Water Quality Portal, WQX3 is the more modern format
that all the data is being converted to.</p>
<p>This is available as of <code>dataRetrieval</code> version 2.7.16.
Starting with 2.7.16, all WQP functions default to the newer “WQX3”
profiles if available. See <a href="#conversion">WQX Conversions</a>
below to get a table of column names in WQX3 vs WQX2.</p>
</div>
<div id="nwis---wqx3" class="section level1" number="4">
<h1><span class="header-section-number">4</span> NWIS -&gt; WQX3</h1>
<div id="readnwisqw" class="section level2" number="4.1">
<h2><span class="header-section-number">4.1</span>
<code>readNWISqw</code></h2>
<p>This function was retired as of Oct. 24, 2024.</p>
<p>So…what do you use instead? The function you will need to move to is
<code>readWQPqw</code>. First, you’ll need to convert the numeric USGS
site ID’s into something that the Water Quality Portal will accept,
which requires the agency prefix. For most USGS sites this will mean
pasting ‘USGS-’ before the site number, although it is important to note
that there are some USGS sites that begin with a different prefix: it is
up to users to determine the agency code..</p>
<p>Here’s an example:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a>wqpData <span class="ot">&lt;-</span> <span class="fu">readWQPqw</span>(<span class="fu">paste0</span>(<span class="st">&quot;USGS-&quot;</span>, site_ids), parameterCd)</span></code></pre></div>
<p>Let’s say we have a data frame that we got from the retired
<code>readNWISqw</code> function and we saved it as
<code>nwisData</code>.</p>
<p>First we compare the number of rows, number of columns, and
attributes to each return:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="fu">nrow</span>(nwisData)</span></code></pre></div>
<pre><code>## [1] 208</code></pre>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="fu">nrow</span>(wqpData)</span></code></pre></div>
<pre><code>## [1] 208</code></pre>
<p>So, same number of rows returned. That’s good, since it’s the same
data.</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="fu">ncol</span>(nwisData)</span></code></pre></div>
<pre><code>## [1] 36</code></pre>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="fu">ncol</span>(wqpData)</span></code></pre></div>
<pre><code>## [1] 67</code></pre>
<p>Different columns!</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="fu">names</span>(<span class="fu">attributes</span>(nwisData))</span></code></pre></div>
<pre><code>##  [1] &quot;names&quot;        &quot;class&quot;        &quot;row.names&quot;   
##  [4] &quot;queryTime&quot;    &quot;url&quot;          &quot;headerInfo&quot;  
##  [7] &quot;comment&quot;      &quot;siteInfo&quot;     &quot;variableInfo&quot;
## [10] &quot;header&quot;</code></pre>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a><span class="fu">names</span>(<span class="fu">attributes</span>(wqpData))</span></code></pre></div>
<pre><code>## [1] &quot;names&quot;      &quot;row.names&quot;  &quot;class&quot;      &quot;headerInfo&quot;
## [5] &quot;legacy&quot;     &quot;siteInfo&quot;   &quot;queryTime&quot;  &quot;url&quot;</code></pre>
<p>Slightly different attributes. You can explore the differences of
those attributes:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a>site_NWIS <span class="ot">&lt;-</span> <span class="fu">attr</span>(nwisData, <span class="st">&quot;siteInfo&quot;</span>)</span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>site_WQP <span class="ot">&lt;-</span> <span class="fu">attr</span>(wqpData, <span class="st">&quot;siteInfo&quot;</span>)</span></code></pre></div>
<p>The next big task is figuring out which columns from the WQP output
map to the original columns from the NWIS output. Look at your workflow
and determine what columns from the original NWIS output are needed to
preserve the integrity of the workflow.</p>
<p>Let’s use the <code>dplyr</code> package to pull out the columns are
used in this example workflow, and make sure both NWIS and WQP are
ordered in the same way.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="fu">library</span>(dplyr)</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a></span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>nwisData_relevant <span class="ot">&lt;-</span> nwisData <span class="sc">|&gt;</span> </span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a>    site_no, startDateTime, parm_cd,</span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>    remark_cd, result_va</span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a>  <span class="fu">arrange</span>(startDateTime, parm_cd)</span>
<span id="cb15-9"><a href="#cb15-9" tabindex="-1"></a></span>
<span id="cb15-10"><a href="#cb15-10" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="fu">head</span>(nwisData_relevant))</span></code></pre></div>
<table>
<thead>
<tr class="header">
<th align="left">site_no</th>
<th align="left">startDateTime</th>
<th align="left">parm_cd</th>
<th align="left">remark_cd</th>
<th align="right">result_va</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">04024000</td>
<td align="left">2011-03-15 15:35:00</td>
<td align="left">30234</td>
<td align="left">&lt;</td>
<td align="right">0.16</td>
</tr>
<tr class="even">
<td align="left">04024000</td>
<td align="left">2011-03-15 15:35:00</td>
<td align="left">32104</td>
<td align="left">&lt;</td>
<td align="right">0.16</td>
</tr>
<tr class="odd">
<td align="left">04024000</td>
<td align="left">2011-03-15 15:35:00</td>
<td align="left">34220</td>
<td align="left">&lt;</td>
<td align="right">0.02</td>
</tr>
<tr class="even">
<td align="left">04024000</td>
<td align="left">2011-03-15 15:35:00</td>
<td align="left">34247</td>
<td align="left">&lt;</td>
<td align="right">0.02</td>
</tr>
<tr class="odd">
<td align="left">04024000</td>
<td align="left">2011-04-20 15:00:00</td>
<td align="left">30234</td>
<td align="left">&lt;</td>
<td align="right">0.16</td>
</tr>
<tr class="even">
<td align="left">04024000</td>
<td align="left">2011-04-20 15:00:00</td>
<td align="left">32104</td>
<td align="left">&lt;</td>
<td align="right">0.16</td>
</tr>
</tbody>
</table>
<p>If we explore the output from WQP, we can try to find the columns
that include the same relevant information:</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a>wqpData_relevant <span class="ot">&lt;-</span> wqpData <span class="sc">|&gt;</span> </span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a>    <span class="at">site_no =</span> Location_Identifier,</span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a>    <span class="at">startDateTime =</span> Activity_StartDateTime,</span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a>    <span class="at">parm_cd =</span> USGSpcode,</span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a>    <span class="at">remark_cd =</span> Result_ResultDetectionCondition,</span>
<span id="cb16-7"><a href="#cb16-7" tabindex="-1"></a>    <span class="at">result_va =</span> Result_Measure,</span>
<span id="cb16-8"><a href="#cb16-8" tabindex="-1"></a>    <span class="at">detection_level =</span> DetectionLimit_MeasureA</span>
<span id="cb16-9"><a href="#cb16-9" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb16-10"><a href="#cb16-10" tabindex="-1"></a>  <span class="fu">arrange</span>(startDateTime, parm_cd)</span>
<span id="cb16-11"><a href="#cb16-11" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="fu">head</span>(wqpData_relevant))</span></code></pre></div>
<table style="width:100%;">
<colgroup>
<col width="17%" />
<col width="24%" />
<col width="9%" />
<col width="16%" />
<col width="12%" />
<col width="19%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">site_no</th>
<th align="left">startDateTime</th>
<th align="left">parm_cd</th>
<th align="left">remark_cd</th>
<th align="right">result_va</th>
<th align="right">detection_level</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">USGS-04024000</td>
<td align="left">2011-03-15 15:35:00</td>
<td align="left">30234</td>
<td align="left">Not Detected</td>
<td align="right">NA</td>
<td align="right">0.16</td>
</tr>
<tr class="even">
<td align="left">USGS-04024000</td>
<td align="left">2011-03-15 15:35:00</td>
<td align="left">32104</td>
<td align="left">Not Detected</td>
<td align="right">NA</td>
<td align="right">0.16</td>
</tr>
<tr class="odd">
<td align="left">USGS-04024000</td>
<td align="left">2011-03-15 15:35:00</td>
<td align="left">34220</td>
<td align="left">Not Detected</td>
<td align="right">NA</td>
<td align="right">0.02</td>
</tr>
<tr class="even">
<td align="left">USGS-04024000</td>
<td align="left">2011-03-15 15:35:00</td>
<td align="left">34247</td>
<td align="left">Not Detected</td>
<td align="right">NA</td>
<td align="right">0.02</td>
</tr>
<tr class="odd">
<td align="left">USGS-04024000</td>
<td align="left">2011-04-20 15:00:00</td>
<td align="left">30234</td>
<td align="left">Not Detected</td>
<td align="right">NA</td>
<td align="right">0.16</td>
</tr>
<tr class="even">
<td align="left">USGS-04024000</td>
<td align="left">2011-04-20 15:00:00</td>
<td align="left">32104</td>
<td align="left">Not Detected</td>
<td align="right">NA</td>
<td align="right">0.16</td>
</tr>
</tbody>
</table>
<p>Now we can start looking at the results and trying to decide how
future workflows should be setup. Here are some decisions for this
example that we can consider:</p>
<div id="censored-values" class="section level3" number="4.1.1">
<h3><span class="header-section-number">4.1.1</span> Censored
values</h3>
<p>The result_va in the NWIS service came back with a value. However,
the data is actually censored, meaning we only know it’s below the
detection limit. With some lazier coding, it might have been really easy
to not realize these values are left-censored. So, while we could
substitute the detection levels into the measured values if there’s an
<code>NA</code> in the measured value, this might be a great time to
update your workflow to handle censored values more robustly. We are
probably interested in maintaining the detection level in another
column.</p>
<p>For this theoretical workflow, let’s think about what we are trying
to find out. Let’s say that we want to know if a value is
“left-censored” or not. Maybe in this case, what would make the most
sense is to have a column that is a logical TRUE/FALSE. For this
example, there was only the text “Not Detected” in the
“ResultDetectionConditionText” column PLEASE NOTE that other data may
include different messages about detection conditions, you will need to
examine your data carefully. Here’s an example from the
<code>EGRET</code> package on how to decide if a
“ResultDetectionConditionText” should be considered a censored
value:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a>censored_text <span class="ot">&lt;-</span> <span class="fu">c</span>(</span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>  <span class="st">&quot;Not Detected&quot;</span>,</span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a>  <span class="st">&quot;Non-Detect&quot;</span>,</span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a>  <span class="st">&quot;Non Detect&quot;</span>,</span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a>  <span class="st">&quot;Detected Not Quantified&quot;</span>,</span>
<span id="cb17-6"><a href="#cb17-6" tabindex="-1"></a>  <span class="st">&quot;Below Quantification Limit&quot;</span></span>
<span id="cb17-7"><a href="#cb17-7" tabindex="-1"></a>)</span>
<span id="cb17-8"><a href="#cb17-8" tabindex="-1"></a></span>
<span id="cb17-9"><a href="#cb17-9" tabindex="-1"></a>wqpData_relevant <span class="ot">&lt;-</span> wqpData <span class="sc">|&gt;</span> </span>
<span id="cb17-10"><a href="#cb17-10" tabindex="-1"></a>  <span class="fu">mutate</span>(<span class="at">left_censored =</span> <span class="fu">grepl</span>(<span class="fu">paste</span>(censored_text, <span class="at">collapse =</span> <span class="st">&quot;|&quot;</span>),</span>
<span id="cb17-11"><a href="#cb17-11" tabindex="-1"></a>    Result_ResultDetectionCondition,</span>
<span id="cb17-12"><a href="#cb17-12" tabindex="-1"></a>    <span class="at">ignore.case =</span> <span class="cn">TRUE</span></span>
<span id="cb17-13"><a href="#cb17-13" tabindex="-1"></a>  )) <span class="sc">|&gt;</span> </span>
<span id="cb17-14"><a href="#cb17-14" tabindex="-1"></a>  <span class="fu">select</span>(</span>
<span id="cb17-15"><a href="#cb17-15" tabindex="-1"></a>    <span class="at">site_no =</span> Location_Identifier,</span>
<span id="cb17-16"><a href="#cb17-16" tabindex="-1"></a>    <span class="at">startDateTime =</span> Activity_StartDateTime,</span>
<span id="cb17-17"><a href="#cb17-17" tabindex="-1"></a>    <span class="at">parm_cd =</span> USGSpcode,</span>
<span id="cb17-18"><a href="#cb17-18" tabindex="-1"></a>    left_censored,</span>
<span id="cb17-19"><a href="#cb17-19" tabindex="-1"></a>    <span class="at">result_va =</span> Result_Measure,</span>
<span id="cb17-20"><a href="#cb17-20" tabindex="-1"></a>    <span class="at">detection_level =</span> DetectionLimit_MeasureA,</span>
<span id="cb17-21"><a href="#cb17-21" tabindex="-1"></a>    <span class="at">dl_units =</span> DetectionLimit_MeasureUnitA</span>
<span id="cb17-22"><a href="#cb17-22" tabindex="-1"></a>  ) <span class="sc">|&gt;</span> </span>
<span id="cb17-23"><a href="#cb17-23" tabindex="-1"></a>  <span class="fu">arrange</span>(startDateTime, parm_cd)</span>
<span id="cb17-24"><a href="#cb17-24" tabindex="-1"></a></span>
<span id="cb17-25"><a href="#cb17-25" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(<span class="fu">head</span>(wqpData_relevant))</span></code></pre></div>
<table style="width:100%;">
<colgroup>
<col width="15%" />
<col width="21%" />
<col width="8%" />
<col width="15%" />
<col width="10%" />
<col width="17%" />
<col width="9%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">site_no</th>
<th align="left">startDateTime</th>
<th align="left">parm_cd</th>
<th align="left">left_censored</th>
<th align="right">result_va</th>
<th align="right">detection_level</th>
<th align="left">dl_units</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">USGS-04024000</td>
<td align="left">2011-03-15 15:35:00</td>
<td align="left">30234</td>
<td align="left">TRUE</td>
<td align="right">NA</td>
<td align="right">0.16</td>
<td align="left">ug/L</td>
</tr>
<tr class="even">
<td align="left">USGS-04024000</td>
<td align="left">2011-03-15 15:35:00</td>
<td align="left">32104</td>
<td align="left">TRUE</td>
<td align="right">NA</td>
<td align="right">0.16</td>
<td align="left">ug/L</td>
</tr>
<tr class="odd">
<td align="left">USGS-04024000</td>
<td align="left">2011-03-15 15:35:00</td>
<td align="left">34220</td>
<td align="left">TRUE</td>
<td align="right">NA</td>
<td align="right">0.02</td>
<td align="left">ug/L</td>
</tr>
<tr class="even">
<td align="left">USGS-04024000</td>
<td align="left">2011-03-15 15:35:00</td>
<td align="left">34247</td>
<td align="left">TRUE</td>
<td align="right">NA</td>
<td align="right">0.02</td>
<td align="left">ug/L</td>
</tr>
<tr class="odd">
<td align="left">USGS-04024000</td>
<td align="left">2011-04-20 15:00:00</td>
<td align="left">30234</td>
<td align="left">TRUE</td>
<td align="right">NA</td>
<td align="right">0.16</td>
<td align="left">ug/L</td>
</tr>
<tr class="even">
<td align="left">USGS-04024000</td>
<td align="left">2011-04-20 15:00:00</td>
<td align="left">32104</td>
<td align="left">TRUE</td>
<td align="right">NA</td>
<td align="right">0.16</td>
<td align="left">ug/L</td>
</tr>
</tbody>
</table>
</div>
<div id="nwis-codes" class="section level3" number="4.1.2">
<h3><span class="header-section-number">4.1.2</span> NWIS codes</h3>
<p>Another difference that is going to require some thoughtful decisions
is how to interpret additional NWIS codes. They will now be descriptive
text. Columns such as samp_type_cd and medium_cd will now all be
reported with descriptive words rather than single letters or numbers.
It will be the responsibility of the user to consider the best way to
deal with these changes.</p>
<p>If you use the <code>readNWISqw</code> function, you WILL need to
adjust your workflows, and you may find there are more codes you will
need to account for. Hopefully this section helped get you started. It
does not include every scenario, so you may find more columns or codes
or other conditions you need to account for.</p>
</div>
</div>
</div>
<div id="whatnwisdata" class="section level1" number="5">
<h1><span class="header-section-number">5</span> whatNWISdata</h1>
<p>This function will continue to work for any service EXCEPT “qw”
(water quality discrete data). “qw” results will eventually no longer be
returned, and are currently showing values that were frozen in March
2024.</p>
<p>The function to replace this functionality for discrete water quality
data is currently <code>whatWQPdata</code>:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a>whatNWIS <span class="ot">&lt;-</span> <span class="fu">whatNWISdata</span>(</span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a>  <span class="at">siteNumber =</span> site_ids,</span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a>  <span class="at">service =</span> <span class="st">&quot;qw&quot;</span></span>
<span id="cb18-4"><a href="#cb18-4" tabindex="-1"></a>)</span></code></pre></div>
<pre><code>WARNING: NWIS does not deliver
new discrete water quality data or updates to existing data. 
For additional details, see:
https://doi-usgs.github.io/dataRetrieval/articles/Status.html</code></pre>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a>whatWQP <span class="ot">&lt;-</span> <span class="fu">whatWQPdata</span>(<span class="at">siteNumber =</span> <span class="fu">paste0</span>(<span class="st">&quot;USGS-&quot;</span>, site_ids))</span></code></pre></div>
<p>There are some major differences in the output. The NWIS services
offers back one row per site/parameter code to learn how many samples
are available. This is not <em>currently</em> available from the Water
Quality Portal, however there are new summary services being developed.
When those become available, we will include new documentation on how to
get this information.</p>
</div>
<div id="readnwisdata" class="section level1" number="6">
<h1><span class="header-section-number">6</span> readNWISdata</h1>
<p>If you get your water quality data from the <code>readNWISdata</code>
function, no new data will be available and the function will generate a
warning message. The other services are working as before. This is not
an especially common <code>dataRetrieval</code> workflow, so there are
not a lot of details here. Please reach out if more information is
needed to update your workflows.</p>
<p>See <code>?readWQPdata</code> to see all the ways to query data in
the Water Quality Portal. Use the suggestions above to convert the
output of the <code>readWQPdata</code> function to convert the WQP
output to what is important for your workflow.</p>
</div>
<div id="conversion" class="section level1" number="7">
<h1><span class="header-section-number">7</span> WQX Conversion</h1>
<p>A table is provided on the EPA website that shows the conversions of
WQX3 to the WQX2 mappings. This table may change periodically while WQP
services are under active development, which is expected to last through
Fall 2024.</p>
<p>Here is an example for pulling the EPA table and comparing column
names.</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a>schema <span class="ot">&lt;-</span> readr<span class="sc">::</span><span class="fu">read_csv</span>(<span class="st">&quot;https://www.epa.gov/system/files/other-files/2024-07/schema_outbound_wqx3.0.csv&quot;</span>)</span></code></pre></div>
<p>Within that schema table, the column “FieldName3.0” shows the column
names for the new WQX3 profile. There are several “FieldName2.0.XXXX”
columns that show how the older 2.0 profiles align with the newer
columns.</p>
<p>For example, the 2.0 “narrow” dataProfile match up with these new
WQP3 columns:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a>sub_schema <span class="ot">&lt;-</span> schema <span class="sc">|&gt;</span> </span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a>  <span class="fu">select</span>(<span class="at">WQX3 =</span> FieldName3<span class="fl">.0</span>,</span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a>         <span class="at">WQX2 =</span> FieldName2.<span class="fl">0.</span>Narrow) <span class="sc">|&gt;</span> </span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a>  <span class="fu">filter</span>(<span class="sc">!</span><span class="fu">is.na</span>(WQX2))</span>
<span id="cb22-5"><a href="#cb22-5" tabindex="-1"></a></span>
<span id="cb22-6"><a href="#cb22-6" tabindex="-1"></a>knitr<span class="sc">::</span><span class="fu">kable</span>(sub_schema)</span></code></pre></div>
<table>
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<thead>
<tr class="header">
<th align="left">WQX3</th>
<th align="left">WQX2</th>
</tr>
</thead>
<tbody>
<tr class="odd">
<td align="left">Org_Identifier</td>
<td align="left">OrganizationIdentifier</td>
</tr>
<tr class="even">
<td align="left">Org_FormalName</td>
<td align="left">OrganizationFormalName</td>
</tr>
<tr class="odd">
<td align="left">ProviderName</td>
<td align="left">ProviderName</td>
</tr>
<tr class="even">
<td align="left">Location_Identifier</td>
<td align="left">MonitoringLocationIdentifier</td>
</tr>
<tr class="odd">
<td align="left">Activity_ActivityIdentifier</td>
<td align="left">ActivityIdentifier</td>
</tr>
<tr class="even">
<td align="left">Activity_StartDate</td>
<td align="left">ActivityStartDate</td>
</tr>
<tr class="odd">
<td align="left">Activity_StartTime</td>
<td align="left">ActivityStartTime/Time</td>
</tr>
<tr class="even">
<td align="left">Activity_StartTimeZone</td>
<td align="left">ActivityStartTime/TimeZoneCode</td>
</tr>
<tr class="odd">
<td align="left">SampleCollectionMethod_Description</td>
<td align="left">MethodDescriptionText</td>
</tr>
<tr class="even">
<td align="left">SamplePrepMethod_Description</td>
<td align="left">MethodDescriptionText</td>
</tr>
<tr class="odd">
<td align="left">Result_ResultDetectionCondition</td>
<td align="left">ResultDetectionConditionText</td>
</tr>
<tr class="even">
<td align="left">Result_Characteristic</td>
<td align="left">CharacteristicName</td>
</tr>
<tr class="odd">
<td align="left">ResultBiological_Intent</td>
<td align="left">BiologicalIntentName</td>
</tr>
<tr class="even">
<td align="left">ResultBiological_IndividualIdentifier</td>
<td align="left">BiologicalIndividualIdentifier</td>
</tr>
<tr class="odd">
<td align="left">ResultBiological_Taxon</td>
<td align="left">SubjectTaxonomicName</td>
</tr>
<tr class="even">
<td align="left">ResultBiological_UnidentifiedSpeciesIdentifier</td>
<td align="left">UnidentifiedSpeciesIdentifier</td>
</tr>
<tr class="odd">
<td align="left">ResultBiological_SampleTissueAnatomy</td>
<td align="left">SampleTissueAnatomyName</td>
</tr>
<tr class="even">
<td align="left">Taxonomy_CellForm</td>
<td align="left">CellFormName</td>
</tr>
<tr class="odd">
<td align="left">Taxonomy_CellShape</td>
<td align="left">CellShapeName</td>
</tr>
<tr class="even">
<td align="left">Taxonomy_Habit</td>
<td align="left">HabitName</td>
</tr>
<tr class="odd">
<td align="left">Taxonomy_PollutionTolerance</td>
<td align="left">TaxonomicPollutionTolerance</td>
</tr>
<tr class="even">
<td align="left">Taxonomy_PollutionToleranceScale</td>
<td align="left">TaxonomicPollutionToleranceScaleText</td>
</tr>
<tr class="odd">
<td align="left">Taxonomy_TrophicLevel</td>
<td align="left">TrophicLevelName</td>
</tr>
<tr class="even">
<td align="left">Taxonomy_FunctionalFeedingGroup</td>
<td align="left">FunctionalFeedingGroupName</td>
</tr>
<tr class="odd">
<td align="left">TaxonomyCitation_ResourceTitle</td>
<td align="left">TaxonomicDetailsCitation/ResourceTitleName</td>
</tr>
<tr class="even">
<td align="left">TaxonomyCitation_ResourceCreator</td>
<td align="left">TaxonomicDetailsCitation/ResourceCreatorName</td>
</tr>
<tr class="odd">
<td align="left">TaxonomyCitation_ResourceSubject</td>
<td align="left">TaxonomicDetailsCitation/ResourceSubjectText</td>
</tr>
<tr class="even">
<td align="left">TaxonomyCitation_ResourcePublisher</td>
<td align="left">TaxonomicDetailsCitation/ResourcePublisherName</td>
</tr>
<tr class="odd">
<td align="left">TaxonomyCitation_ResourceDate</td>
<td align="left">TaxonomicDetailsCitation/ResourceDate</td>
</tr>
<tr class="even">
<td align="left">TaxonomyCitation_ResourceIdentifier</td>
<td align="left">TaxonomicDetailsCitation/ResourceIdentifier</td>
</tr>
<tr class="odd">
<td align="left">ResultDepthHeight_Measure</td>
<td align="left">ResultDepthHeightMeasure/MeasureValue</td>
</tr>
<tr class="even">
<td align="left">ResultDepthHeight_MeasureUnit</td>
<td align="left">ResultDepthHeightMeasure/MeasureUnitCode</td>
</tr>
<tr class="odd">
<td align="left">ResultDepthHeight_AltitudeReferencePoint</td>
<td align="left">ResultDepthAltitudeReferencePointText</td>
</tr>
<tr class="even">
<td align="left">ResultDepthHeight_SamplingPointName</td>
<td align="left">ResultSamplingPointName</td>
</tr>
<tr class="odd">
<td align="left">Result_MeasureIdentifier</td>
<td align="left">ResultIdentifier</td>
</tr>
<tr class="even">
<td align="left">Result_Measure</td>
<td align="left">ResultMeasureValue</td>
</tr>
<tr class="odd">
<td align="left">Result_MeasureUnit</td>
<td align="left">ResultMeasure/MeasureUnitCode</td>
</tr>
<tr class="even">
<td align="left">Result_MeasureQualifierCode</td>
<td align="left">MeasureQualifierCode</td>
</tr>
<tr class="odd">
<td align="left">Result_MeasureStatusIdentifier</td>
<td align="left">ResultStatusIdentifier</td>
</tr>
<tr class="even">
<td align="left">Result_StatisticalBase</td>
<td align="left">StatisticalBaseCode</td>
</tr>
<tr class="odd">
<td align="left">Result_MeasureType</td>
<td align="left">ResultValueTypeName</td>
</tr>
<tr class="even">
<td align="left">DataQuality_PrecisionValue</td>
<td align="left">PrecisionValue</td>
</tr>
<tr class="odd">
<td align="left">DataQuality_BiasValue</td>
<td align="left">DataQuality/BiasValue</td>
</tr>
<tr class="even">
<td align="left">DataQuality_ConfidenceIntervalValue</td>
<td align="left">ConfidenceIntervalValue</td>
</tr>
<tr class="odd">
<td align="left">DataQuality_UpperConfidenceLimitValue</td>
<td align="left">UpperConfidenceLimitValue</td>
</tr>
<tr class="even">
<td align="left">DataQuality_LowerConfidenceLimitValue</td>
<td align="left">LowerConfidenceLimitValue</td>
</tr>
<tr class="odd">
<td align="left">DataQuality_ResultComment</td>
<td align="left">ResultCommentText</td>
</tr>
<tr class="even">
<td align="left">DetectionLimit_LabAccreditationIndicator</td>
<td align="left">LaboratoryAccreditationIndicator</td>
</tr>
<tr class="odd">
<td align="left">DetectionLimit_LabAccreditationAuthority</td>
<td align="left">LaboratoryAccreditationAuthorityName</td>
</tr>
<tr class="even">
<td align="left">DetectionLimit_TaxonAccreditationIndicator</td>
<td align="left">TaxonomistAccreditationIndicator</td>
</tr>
<tr class="odd">
<td align="left">DetectionLimit_TaxonAccreditationAuthority</td>
<td align="left">TaxonomistAccreditationAuthorityName</td>
</tr>
<tr class="even">
<td align="left">ResultAnalyticalMethod_Identifier</td>
<td align="left">ResultAnalyticalMethod/MethodIdentifier</td>
</tr>
<tr class="odd">
<td align="left">ResultAnalyticalMethod_IdentifierContext</td>
<td align="left">ResultAnalyticalMethod/MethodIdentifierContext</td>
</tr>
<tr class="even">
<td align="left">ResultAnalyticalMethod_Name</td>
<td align="left">ResultAnalyticalMethod/MethodName</td>
</tr>
<tr class="odd">
<td align="left">ResultAnalyticalMethod_QualifierType</td>
<td align="left">ResultAnalyticalMethod/MethodQualifierTypeName</td>
</tr>
<tr class="even">
<td align="left">ResultAnalyticalMethod_Description</td>
<td align="left">MethodDescriptionText</td>
</tr>
<tr class="odd">
<td align="left">LabInfo_Name</td>
<td align="left">LaboratoryName</td>
</tr>
<tr class="even">
<td align="left">LabInfo_AnalysisStartDate</td>
<td align="left">AnalysisStartDate</td>
</tr>
<tr class="odd">
<td align="left">LabInfo_AnalysisStartTime</td>
<td align="left">AnalysisStartTime/Time</td>
</tr>
<tr class="even">
<td align="left">LabInfo_AnalysisStartTimeZone</td>
<td align="left">AnalysisStartTime/TimeZoneCode</td>
</tr>
<tr class="odd">
<td align="left">LabInfo_AnalysisEndDate</td>
<td align="left">AnalysisEndDate</td>
</tr>
<tr class="even">
<td align="left">LabInfo_AnalysisEndTime</td>
<td align="left">AnalysisEndTime/Time</td>
</tr>
<tr class="odd">
<td align="left">LabInfo_AnalysisEndTimeZone</td>
<td align="left">AnalysisEndTime/TimeZoneCode</td>
</tr>
<tr class="even">
<td align="left">LabSamplePrepMethod_Description</td>
<td align="left">MethodDescriptionText</td>
</tr>
<tr class="odd">
<td align="left">USGSpcode</td>
<td align="left">USGSPCode</td>
</tr>
</tbody>
</table>
</div>
<div id="disclaimer" class="section level1" number="8">
<h1><span class="header-section-number">8</span> Disclaimer</h1>
<p>This information is preliminary and is subject to revision. It is
being provided to meet the need for timely best science. The information
is provided on the condition that neither the U.S. Geological Survey nor
the U.S. Government may be held liable for any damages resulting from
the authorized or unauthorized use of the information.</p>
</div>



<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
